<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Healthcare Multi-Agent System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-bubble {
            background: #10b981;
            color: white;
            margin-left: auto;
        }
        .agent-bubble {
            background: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                ðŸ©º Personalized Healthcare Multi-Agent System
            </h1>
            <p class="text-gray-600">
                Your AI-powered healthcare assistant for mood tracking, CGM monitoring, and meal planning.
            </p>
        </div>

        <!-- Chat Interface -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ðŸ’¬ Chat with Your Health Assistant</h2>
            
            <!-- Chat Messages -->
            <div id="chatMessages" class="h-96 overflow-y-auto border border-gray-200 rounded-lg p-4 mb-4 bg-gray-50">
                <div class="text-center text-gray-500">
                    <div class="text-4xl mb-2">ðŸ‘‹</div>
                    <p>Hello! I'm your Healthcare Coordinator.</p>
                    <p class="text-sm mt-1">Try: "My ID is 42" or "I'm feeling tired"</p>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="flex space-x-2">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Type a message..." 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                />
                <button 
                    onclick="sendMessage()" 
                    id="sendButton"
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                >
                    Send
                </button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">âš¡ Quick Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="quickAction('My ID is 42')" class="p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                    <div class="text-2xl mb-2">ðŸ‘¤</div>
                    <div class="font-medium">Set User ID</div>
                    <div class="text-sm text-gray-600">Enter your user ID (1-100)</div>
                </button>
                <button onclick="quickAction('I am feeling happy')" class="p-4 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                    <div class="text-2xl mb-2">ðŸ˜Š</div>
                    <div class="font-medium">Log Mood</div>
                    <div class="text-sm text-gray-600">Track your current mood</div>
                </button>
                <button onclick="quickAction('My glucose reading is 120')" class="p-4 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors">
                    <div class="text-2xl mb-2">ðŸ“ˆ</div>
                    <div class="font-medium">Log CGM</div>
                    <div class="text-sm text-gray-600">Record glucose reading</div>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let isLoading = false;

        // Get the API base URL (Railway will set this)
        const API_BASE = window.location.origin;

        function addMessage(text, sender, type = 'normal') {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubbleClass = sender === 'user' ? 'user-bubble' : 'agent-bubble';
            const bubbleColor = type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : bubbleClass;
            
            messageDiv.innerHTML = `
                <div class="chat-bubble px-4 py-2 rounded-lg ${bubbleColor}">
                    <p class="text-sm">${text}</p>
                    <p class="text-xs mt-1 opacity-70">${new Date().toLocaleTimeString()}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function setLoading(loading) {
            isLoading = loading;
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            
            sendButton.disabled = loading;
            messageInput.disabled = loading;
            sendButton.textContent = loading ? 'Sending...' : 'Send';
        }

        async function sendMessage(customMessage = null) {
            const messageInput = document.getElementById('messageInput');
            const message = customMessage || messageInput.value.trim();
            
            if (!message || isLoading) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            
            if (!customMessage) {
                messageInput.value = '';
            }
            
            setLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/ag-ui-agent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        user_id: currentUserId,
                        session_id: 'web-session'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(data.response, 'agent', 'success');
                    
                    // Extract user ID if mentioned
                    if (message.toLowerCase().includes('my id is') || message.toLowerCase().includes('user id')) {
                        const idMatch = message.match(/\d+/);
                        if (idMatch) {
                            currentUserId = parseInt(idMatch[0]);
                        }
                    }
                } else {
                    addMessage(`Error: ${data.detail || 'Something went wrong'}`, 'agent', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Error: Could not connect to the healthcare agent. Please try again.', 'agent', 'error');
            } finally {
                setLoading(false);
            }
        }

        function quickAction(message) {
            sendMessage(message);
        }

        // Handle Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
